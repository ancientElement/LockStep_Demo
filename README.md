>è½¬è½½è¯·æ ‡æ˜å‡ºå¤„
## å‰è¨€

æ¦‚è§ˆç°æœ‰çš„å¸§åŒæ­¥è§†é¢‘èµ„æ–™ä¸æ–‡æ¡£èµ„æ–™ï¼Œè¦ä¸å°±æ˜¯ä»…ä»…ç®€è¿°ä¸€ä¸ªå¸§åŒæ­¥çš„æ¶æ„ï¼Œå†å°±æ˜¯ä»¥åŠå†™å¥½äº†ä¸€ä¸ªæ¯”è¾ƒå…·æœ‰è§„æ¨¡çš„å¸§åŒæ­¥æ¡†æ¶ï¼Œä»€ä¹ˆ**å®šç‚¹æ•°**ï¼Œ**UDP**ï¼Œ**è‡ªå®šä¹‰ç‰©ç†åŒæ­¥**ä¸€åº”ä¿±å…¨ï¼Œä¸€æ—¶é—´è®©è¯»è€…æ‘¸ä¸ç€å¤´è„‘ã€‚

æœ¬æ•™ç¨‹ä»ä¸€ä¸ª**å°DEMO**å‡ºå‘ï¼Œä»æœ€å¤æ—©çš„**å¸§é”å®šåŒæ­¥ç®—æ³•**å¼€å§‹é€æ­¥è®²è§£**è¿½å¸§**ã€**å½•åƒå›æ”¾**ã€**é¢„æµ‹å›æ»š**

æœ¬DEMOçš„åŸºç¡€æ˜¯[ancientElement/NetGameBook (github.com)](https://github.com/ancientElement/NetGameBook)TCPé€šä¿¡æ¡†æ¶ã€‚

æœ‰çš„åŒå­¦å°±ä¼šè¯´ï¼šä¸ºä»€ä¹ˆç”¨**TCP**å‘¢ï¼Œä¸ºä»€ä¹ˆä¸ç”¨**UDP**ï¼Ÿ

å…¶å®ï¼Œåœ¨åˆæœŸå­¦ä¹ ï¼Œæˆ‘éƒ½æƒ³è¦å°†å­¦ä¹ æˆæœ¬å°½å¯èƒ½çš„å‹ç¼©ï¼Œç°åœ¨åˆšå¥½æœ‰ä¸éœ€è¦å¤„ç†**ä¹±åº**å’Œ**ä¸¢åŒ…**çš„TCPå¹²å˜›ä¸å»ç”¨å‘¢ï¼Ÿ

è¿™é‡Œå¼•ç”¨ä¸€ä¸‹SkyWindçš„è¯ï¼š

![img](ImagesAssets/Pasted image 20240227080921.png)
<center>å›¾1 TCPè¿˜æ˜¯UDP</center>

å…¶å®å¸§åŒæ­¥å’ŒçŠ¶æ€åŒæ­¥ï¼Œåœ¨æˆ‘çš„ç†è§£ä¸­ï¼Œ**å¸§åŒæ­¥**æ˜¯è½¬å‘**æ“ä½œ**ï¼Œ**çŠ¶æ€åŒæ­¥**æ˜¯è½¬å‘**ç»“æœ**ã€‚

å¸§åŒæ­¥è¿˜éœ€è¦ç»è¿‡**æ“ä½œè¾“å…¥--ã€‹æ¨¡æ‹Ÿ**ï¼Œçš„è¿‡ç¨‹æ‰å¯ä»¥å¾—åˆ°ç»“æœï¼Œè¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼Œ**åæ¥çš„**å®¢æˆ·ç«¯æ€ä¹ˆåŠï¼Œä»–æ²¡æœ‰æ”¶åˆ°åˆ°è¿‡**å…¶ä»–ç©å®¶**ä¹‹å‰çš„æ“ä½œè¾“å…¥æ€ä¹ˆå¾—åˆ°å…¶ä»–ç©å®¶**ç°åœ¨çš„çŠ¶æ€**ï¼Œéš¾ä¸æˆè¦å‚¨å­˜ä¸€ä¸ªç©å®¶çŠ¶æ€å‘é€ç»™**ååŠ å…¥çš„ç©å®¶å—**ï¼Ÿ

NONONOï¼Œæ—©æœŸçš„è¯ï¼Œå¯ä»¥è®¾è®¡æˆ**å…¨éƒ¨çš„ç©å®¶è¿›å…¥**æ‰ä¼šå¼€å§‹æ¸¸æˆï¼Œè¿™æ ·æ‰€æœ‰ç©å®¶çš„éƒ½ä¼šæœ‰**ç›¸åŒçš„**æ“ä½œè¾“å…¥ã€‚å¹¶ä¸”è¿™æ ·çš„è®¾è®¡æ˜¯æ— æ³•å®ç°**æ‰çº¿é‡è¿**å’Œ**åæ¥åŠ å…¥**çš„ã€‚

è¦è®¾è®¡æˆä¸ºæ”¯æŒæ‰çº¿é‡è¿ï¼Œéœ€è¦ä¿å­˜ä¸€ä¸ªæ‰€æœ‰ç©å®¶çš„**æ¯å¸§**æ“ä½œè¾“å…¥ã€‚æœ‰ç©å®¶åŠ å…¥ä¹‹åï¼Œä»–çš„å®¢æˆ·ç«¯æœ¬åœ°å‘é€ä¸€ä¸ªæ›´æ–°**ç¬¬0å¸§**æ“ä½œçš„æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨æ”¶åˆ°ä»¥åï¼Œå‘ç°å§æ§½æˆ‘åˆ°è·‘åˆ°**ç¬¬10å¸§**äº†è¿™è€å¼Ÿè¿˜è¦æ›´æ–°**ç¬¬0å¸§**ï¼Œåœ¨ç»Ÿä¸€å‘é€ç¬¬10å¸§æ—¶ï¼Œå•ç‹¬é’ˆå¯¹å‘é€ç»™è¿™ä¸ªè€å¼Ÿçš„æ¶ˆæ¯ä¸­å°†**ç¬¬0å¸§åˆ°ç¬¬10å¸§**çš„æ‰€æœ‰æ“ä½œæ‰“åŒ…ï¼Œå…¶ä»–äººçš„ç…§æˆä¸å˜ã€‚

è€å¼ŸæœåŠ¡å™¨æ¥æ”¶åˆ°**ç¬¬0å¸§åˆ°ç¬¬10å¸§**çš„æ‰€æœ‰æ“ä½œåï¼Œå°†å…¶ç©å®¶çš„è¾“å…¥æ“ä½œ**å¿«é€Ÿæ¨¡æ‹Ÿ**ä¸€éç›´åˆ°**ç¬¬10å¸§**ï¼ŒçœŸå°±æ˜¯ä¸ºä»€ä¹ˆä½ æ‰“**ç‹è€…è£è€€**çš„æ—¶å€™æ‰çº¿äº†ï¼Œé‡æ–°è¿æ¥åä¼šæœ‰è‡ªå·±å’Œå…¶ä»–ç©å®¶çš„**å¿«é€Ÿå½±åƒ**ã€‚


### å¸§åŒæ­¥å’ŒçŠ¶æ€åŒæ­¥çš„å¯¹æ¯”

#### çŠ¶æ€åŒæ­¥çš„æ–¹æ¡ˆç‰¹ç‚¹

- ä¼˜ç‚¹
  
    - **å®‰å…¨**ï¼ˆå› ä¸ºæœ‰å…³é”®é€»è¾‘éƒ½åœ¨æœåŠ¡å™¨ä¸Šï¼‰
      
    - **ç½‘ç»œè¦æ±‚ä½**
      
    - **æ–­çº¿é‡å›å¿«**ï¼ˆå› ä¸ºæœ‰çŠ¶æ€å¿«ç…§ï¼‰
      
    - **å®¢æˆ·ç«¯æ€§èƒ½ä¼˜åŒ–**ï¼ˆè§†é‡ä¹‹å¤–é€»è¾‘å¯ä»¥ä¸è¦çš„ï¼Œåæ­£æœåŠ¡å™¨åœ¨ç®—å…¨å±€çš„ï¼‰ã€‚æ‰€ä»¥åƒäººå¤§æˆ˜è¿™ç§ä¸€å®šæ˜¯C/Sæ¶æ„çš„ã€‚
      
    
- ç¼ºç‚¹
  
    - **å¼€å‘æ…¢**ï¼ˆå› ä¸ºè¦è”è°ƒï¼‰
      
    - **å½•åƒå›æ”¾å®ç°è¾ƒéš¾**
      
    - **æ‰“å‡»æ„Ÿéš¾è°ƒ**
      
    - **è€—æµé‡**

#### å¸§åŒæ­¥çš„æ–¹æ¡ˆç‰¹ç‚¹

- ä¼˜ç‚¹å’Œç¼ºç‚¹æ°å¥½æ˜¯çŠ¶æ€åŒæ­¥æ–¹æ¡ˆçš„äº’è¡¥ã€‚å…¶ä¸­å¤–æŒ‚æ˜¯ä¸€ä¸ªé‡ç‚¹ï¼Œè€Œæ–­çº¿é‡å›æ—¶é—´é•¿æ˜¯ä¸€ä¸ªéš¾ç‚¹ï¼Œä¸èƒ½èƒœä»»åƒäººå¤§æˆ˜æ˜¯æ— æ³•çªç ´çš„ç“¶é¢ˆï¼ˆå› ä¸ºæ‰€æœ‰ä¸œè¥¿éƒ½è¦æ”¾åœ¨å®¢æˆ·ç«¯ç®—ï¼‰ã€‚

æ­¤å¤–ï¼Œå¸§åŒæ­¥å¸¸ç”¨åˆ°bufferï¼Œå…¶å»¶è¿Ÿæ¯”çŠ¶æ€åŒæ­¥æ˜¯è¦å¤§çš„ã€‚

## å¸§é”å®šåŒæ­¥ç®—æ³•-ä»Demoå¼€å§‹è®²è§£

å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ä¸€å¼ å›¾ç‰‡çš„æµç¨‹ï¼š

![3qtcd](ImagesAssets/3qtcd.png)
<center>å›¾2 å¸§é”å®šåŒæ­¥æµç¨‹å›¾</center>

æ–‡å­—æµç¨‹ï¼š

æœåŠ¡å™¨
1. ç©å®¶å°±ä½åå‘é€**ç¬¬0å¸§**çš„æ“ä½œï¼Œç¬¬0å¸§éƒ½æ˜¯ç©ºæ“ä½œã€‚
2. ç­‰å¾…**ç¬¬1å¸§**çš„æ‰€æœ‰ç©å®¶æ¥æ”¶æ“ä½œåˆ°ä½ã€‚
	1. æ¥æ”¶åˆ°ä½åï¼Œå¹¿æ’­æ‰€æœ‰ç©å®¶å½“å‰å¸§æ“ä½œï¼Œå½“å‰å¸§åŠ ä¸€ã€‚

å®¢æˆ·ç«¯ï¼š
1. ç­‰åˆ°**ç¬¬0å¸§**çš„åˆ°æ¥ï¼Œ**ç¬¬0å¸§**æ²¡åˆ°ä¸å…è®¸ä¸Šä¼ æ“ä½œã€‚
	1. æ¥æ”¶åˆ°ç¬¬0å¸§åï¼Œæ›´æ–°é€»è¾‘å¸§ã€‚
2. æ¥æ”¶åˆ°**ç¬¬0å¸§**åï¼Œç­‰å¾…66msï¼ˆFPSï¼š15ï¼‰æœé›†å¹¶ä¸”ä¸Šä¼ **ç¬¬1å¸§**çš„æ“ä½œï¼Œæ²¡æœ‰æ¥æ”¶åˆ°ä¸å…è®¸ä¸Šä¼ ã€‚

>æ²¡é”™å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œéƒ½è¯´äº†æ˜¯æµ…å…¥æµ…å‡ºã€‚

### ç©å®¶è„šæœ¬

å¸§åŒæ­¥çš„æ€§è´¨å†³å®šäº†ï¼Œ`BasePlayer`è„šæœ¬ä¸­åªèƒ½**æ¨¡æ‹Ÿ**ï¼Œ**è¾“å…¥**åªèƒ½ç”±å¤–éƒ¨ç»™åˆ°ã€‚åœ¨`OnLogicUpdate`å‡½æ•°ä¸­ï¼Œæ ¹æ®å‚æ•°`PlayerInputData`æ¥æ¨¡æ‹Ÿå½“å‰å¸§çš„é€»è¾‘æ“ä½œã€‚

åœ¨**é€»è¾‘å±‚é¢**æ›´æ–°é€Ÿåº¦åªæœ‰**15FPS**ï¼Œè·ç¦»**60FPS**ï¼Œå·®äº†å¾ˆå¤§ä¸€æ®µè·¯ç¨‹ï¼Œå¦‚æœæŒ‰ç…§æˆ‘ä»¬çš„é€»è¾‘å¸§æ¥æ›´æ–°æ˜¾ç¤ºï¼Œç”»é¢å°†ä¼šéå¸¸ä¸å ªğŸ™ˆã€‚

è¿™é‡Œé€»è¾‘å¸§æ›´æ–°ä»…ä»…é€šè¿‡è¾“å…¥è®¡ç®—**å¾—åˆ°ç»“æœ**ï¼Œå¹¶ä¸åšç”»é¢ä¸Šçš„æ›´æ–°ï¼Œå¦‚ä¸‹ï¼š

```C#
protected virtual void MoveUpdate(float delta, PlayerInputData playerInput)  
{  
    Move(delta, playerInput);  
}

public void Move(float delta, PlayerInputData playerInput)  
{  
    var direction = new Vector3(playerInput.JoyX, 0, playerInput.JoyY);  
    m_targetPos += direction.normalized * m_velocity * delta;  
}
```

ç”±äºæˆ‘ä»¬æ˜¯æ“ä½œè§’è‰²è¿åŠ¨ï¼Œæˆ‘ä»¬å°†å®é™…çš„ç§»åŠ¨æ”¾åœ¨`OnFixedUpdate`ä¸­ï¼Œå¦‚ä¸‹ï¼š

```C#
public void OnFixedUpdate(float delta)  
{  
    m_go.transform.position = Vector3.MoveTowards(m_go.transform.position, m_targetPos, delta * m_velocity);  
}
```

é™„ï¼š

```C#
public class BasePlayer  
{  
	public enum STATEENUM  
	{  
		idle,  
		move  
	}  

	float m_velocity;  
	STATEENUM m_state;  
	GameObject m_go;  
	Vector3 m_targetPos;  

	public BasePlayer(STATEENUM state, GameObject gameObject, float velocity)  
	{  
		m_state = state;  
		m_go = gameObject;  
		m_velocity = velocity;  
		m_targetPos = m_go.transform.position;  
	}  

	public void OnFixedUpdate(float delta)  
	{  
		m_go.transform.position = Vector3.MoveTowards(m_go.transform.position, m_targetPos, delta * m_velocity);  
	}  

	public void OnLogicUpdate(float delta, PlayerInputData playerInput)  
	{  
		if (playerInput.JoyX != 0 ||  
			playerInput.JoyY != 0)  
		{  
			m_state = STATEENUM.move;  
		}  
		else  
		{  
			m_state = STATEENUM.idle;  
		}  

		switch (m_state)  
		{  
			case STATEENUM.idle:  
				IdleUpdate(delta);  
				break;  
			case STATEENUM.move:  
				MoveUpdate(delta, playerInput);  
				break;  
		}  
	}  

	protected virtual void MoveUpdate(float delta, PlayerInputData playerInput)  
	{  
		Move(delta, playerInput);  
	}  

	protected virtual void IdleUpdate(float delta)  
	{  
		m_targetPos = m_go.transform.position;  
	}  

	public void Move(float delta, PlayerInputData playerInput)  
	{  
		var direction = new Vector3(playerInput.JoyX, 0, playerInput.JoyY);  
		m_targetPos += direction.normalized * m_velocity * delta;  
	}  
}  
```
### PlayerMgr

ç”¨æ¥**æ³¨å†Œç©å®¶**ã€**å‘é€æ³¨å†Œæ¶ˆæ¯**ã€**ç»Ÿä¸€æ›´æ–°**æ‰€æœ‰ç©å®¶çš„**é€»è¾‘å¸§**ã€**è¡¨ç°å¸§**çš„ç®¡ç†è„šæœ¬ã€‚

æœ‰ç‚¹ç±»ä¼¼ä¸`ECS`ä¸­çš„`System`çš„ä½œç”¨ã€‚

ä¹Ÿç±»ä¼¼ä¸å‘½ä»¤æ¨¡å¼ä¸­çš„`CommadMgr`ã€‚

ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬ä¸å‘½ä»¤æ¨¡å¼ä¸åŒï¼Œæˆ‘ä»¬ä¸å‚¨å­˜ä»»ä½•çŠ¶æ€ï¼Œå³ä½¿è¦å­˜å‚¨ï¼Œä¹Ÿä¼šæ”¾åˆ°**æœåŠ¡ç«¯å­˜å‚¨**ã€‚

æˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œå‚¨å­˜å½“å‰å®¢æˆ·ç«¯çš„**ç©å®¶ID**ï¼Œå’Œå…¶ä»–ç©å®¶ï¼š

```C#
public int PlayerID { get; private set; } //æ§åˆ¶çš„ç©å®¶çš„ID  
private Dictionary<int, BasePlayer> m_players; //é”®ä¸ºID
```

åŒæ—¶æä¾›**å‘é€æ³¨å†Œç©å®¶è¯·æ±‚**ã€**ç›‘å¬å…¶ä»–æ³¨å†Œç©å®¶æ³¨å†Œ**ç­‰åŠŸèƒ½ã€‚

é™„ï¼š

```C#
public class PlayerMgr  
{  
    public int PlayerID { get; private set; } //æ§åˆ¶çš„ç©å®¶çš„ID  
    private Dictionary<int, BasePlayer> m_players; //é”®ä¸ºID  
  
    public PlayerMgr()  
    {  
        m_players = new Dictionary<int, BasePlayer>();  
        PlayerID = -1;  
         
        NetAsyncMgr.AddNetMessageListener(MessagePool.RegisterMessage_ID, ReciveRegisterPlayer);  
        NetAsyncMgr.AddNetMessageListener(MessagePool.RegisterSelfMessage_ID, ReciveRegisterSelfPlayer);  
    }  
  
    /// <summary>  
    /// é€»è¾‘æ›´æ–°,å—åˆ°æ›´æ–°æ¶ˆæ¯åæ›´æ–°  
    /// </summary>  
    /// <param name="msg"></param>    
    public void OnLogincUpdate(UpdateMessageData updateData)  
    {  
        for (int i = 0; i < updateData.PlayerInputs.Count; i++)  
        {  
            var playerInput = updateData.PlayerInputs[i];  
            var ID = playerInput.PlayerID;  
            m_players[ID].OnLogicUpdate(updateData.Delta, playerInput);  
        }  
    }  
  
    public void OnFixedUpdate(float delta)  
    {  
        for (int i = 0; i < m_players.Count; i++)  
        {  
            m_players[i].OnFixedUpdate(delta);  
        }  
    }  
  
    /// <summary>  
    /// å‘é€æ³¨å†Œå½“å‰å®¢æˆ·ç«¯ç©å®¶  
    /// </summary>  
    public void SendRegisterPlayer()  
    {  
        RegisterSelfMessage registerSelfMsg = new RegisterSelfMessage();  
        NetAsyncMgr.Send(registerSelfMsg);  
    }  
  
    /// <summary>  
    /// æ¥æ”¶æ³¨å†Œè‡ªå·±  
    /// </summary>  
    public void ReciveRegisterSelfPlayer(BaseMessage msg)  
    {  
        RegisterSelfMessage registerSelfMessage = msg as RegisterSelfMessage;  
        PlayerID = registerSelfMessage.data.PlayerID;  
        RegisterPlayer(registerSelfMessage.data.PlayerID);  
    }  
  
    /// <summary>  
    /// æ¥æ”¶æ³¨å†Œç©å®¶  
    /// </summary>  
    public void ReciveRegisterPlayer(BaseMessage msg)  
    {  
        RegisterMessage registerMsg = msg as RegisterMessage;  
        RegisterPlayer(registerMsg.data.PlayerID);  
    }  
  
    /// <summary>  
    /// çœŸæ­£æ³¨å†Œç©å®¶  
    /// </summary>  
    /// <param name="playerID"></param>    
    /// <exception cref="NotImplementedException"></exception>    
    private BasePlayer RegisterPlayer(int playerID)  
    {  
        var prefab = Resources.Load<GameObject>("Player");  
  
        var go = GameObject.Instantiate(prefab);  
  
        BasePlayer player = new BasePlayer(BasePlayer.STATEENUM.idle, go, 3f);  
        m_players.Add(playerID, player);  
  
        AEDebug.Log("æ³¨å†Œç©å®¶");  
  
        return player;  
    }  
}
```
### NetTick

è¿™ä¸ªè„šæœ¬ä¸­å®ç°äº†ï¼Œä¸Šé¢æµç¨‹ä¸­çš„æ‰€æœ‰å®¢æˆ·ç«¯æ“ä½œï¼Œè¦æ³¨æ„çœ‹å“¦(âŠ™oâŠ™)ã€‚

æ¥æ”¶`UpdateMessage`ï¼Œæœé›†ç©å®¶æ“ä½œä¸Šä¼ `Upload`ã€‚

æˆ‘ä»¬ä¸Šä¼ æ“ä½œæ—¶å¦‚æœæœåŠ¡å™¨æ²¡æœ‰ä¸‹æ”¾**ç¬¬0å¸§**ï¼Œæˆ–è€…**æœªæ¥æ”¶**åˆ°**ä¸Šä¸€æ¬¡ä¸Šä¼ çš„æ“ä½œ**ï¼Œéƒ½ä¸èƒ½ä¸Šä¼ ä¸‹ä¸€å¸§
	å¦‚è¿‡æˆ‘ä»¬å·²ç»æ¥æ”¶åˆ°**ä¸Šä¸€æ¬¡ä¸Šä¼ çš„æ“ä½œ**çš„æ“ä½œï¼Œç­‰å¾…66mså†æ¬¡ä¸Šä¼ ï¼ŒåŒæ—¶`m_reciveFromLastUpLoad`ç½®ä¸º`false`ï¼š

```C#
private void Upload(float delta)  
{  
    //å¦‚æœæ²¡æœ‰æ¥æ”¶åˆ°å½“å‰å¸§åˆ™ç­‰å¾…  
    if (m_playerMgr.PlayerID == -1) return;  
    if (!m_reciveFromLastUpLoad) return;  
    m_timer += delta;  
    if (m_timer >= m_upLoadInterval)  
    {  
        m_timer = 0;  
        UpLoad();  
        AEDebug.Log("å‘å¸ƒ:" + (m_curFrame + 1) + "å¸§æ•°æ®");  
        m_reciveFromLastUpLoad = false;  
    }  
}
```

åœ¨æ¥æ”¶æ—¶åˆ¤æ–­æ”¶åˆ°çš„å¸§æ•°æ®ï¼Œæ˜¯å¦æ˜¯å½“å‰å¸§çš„ä¸‹ä¸€å¸§ï¼Œæ˜¯åˆ™æ›´æ–°æ•°æ®ï¼Œå¹¶ä¸”åŒæ—¶`m_reciveFromLastUpLoad`ç½®ä¸º`true`ï¼Œè¡¨ç¤º**æ¥æ”¶**åˆ°**ä¸Šä¸€æ¬¡ä¸Šä¼ çš„æ“ä½œ**ã€‚

```C#
private void ReciveUpdateMessage(BaseMessage msg)  
{  
    var updateMessage = msg as UpdateMessage;  
    var updateDate = updateMessage.data;  
    if (updateDate.CurFrameIndex == m_curFrame + 1)  
    {  
        m_curFrame = updateDate.CurFrameIndex;  
        m_reciveFromLastUpLoad = true;  
        m_playerMgr.OnLogincUpdate(updateDate);  
    }  
  
    AEDebug.Log(updateDate.Delta);  
    AEDebug.Log("æ¥æ”¶åˆ°ç¬¬:" + updateDate.CurFrameIndex + "å¸§æ•°æ®");  
}
```

é™„å½•ï¼š

```C#
public class NetTick : MonoBehaviour  
{  
	private int m_curFrame;  
	private bool m_reciveFromLastUpLoad;  

	private float m_upLoadInterval; //å•ä½ç§’ é—´éš”å¤šå°‘ä¸Šä¼ æ•°æ®  
	private float m_timer; //è®¡æ—¶å™¨  

	PlayerMgr m_playerMgr;  

	[SerializeField] private string m_serverIP;  
	[SerializeField] private int m_port;  
	[SerializeField] private int m_FPS;  

	[ContextMenu("å¼€å¯è¿æ¥")]  
	public void StartConnect()  
	{  

		NetAsyncMgr.ClearNetMessageListener();  

		m_curFrame = -1;  
		m_timer = 0;  
		SetFPS(m_FPS);  
		m_playerMgr = new PlayerMgr();  

		NetAsyncMgr.AddNetMessageListener(MessagePool.UpdateMessage_ID, ReciveUpdateMessage);  
		NetAsyncMgr.SetMaxMessageFire(m_FPS);  

		NetAsyncMgr.Connect(m_serverIP, m_port);  
	}  
	  
#if Test  
	[ContextMenu("æµ‹è¯•å‘é€æ³¨å†Œè‡ªå·±")]  
	public void TestSendRegisterSelfPlayer()  
	{  
		m_playerMgr.SendRegisterPlayer();  
	}  

	[ContextMenu("æµ‹è¯•å¼€å§‹åŒæ­¥")]  
	public void TestSendStartRoom()  
	{  
		var startRoomMsg = new StartRoomMassage();  
		NetAsyncMgr.Send(startRoomMsg);  
		AEDebug.Log("å¼€å§‹åŒæ­¥");  
	}  

	[ContextMenu("æµ‹è¯•aséœ€è¦æ¶ˆè€—å¤šå°‘æ—¶é—´")]  
	public void TestAsCostTime()  
	{  
		var oldTime = DateTime.Now;  
		for (int i = 0; i < 10000; i++)  
		{  
			BaseMessage msg = new StartRoomMassage();  
			var startRoomMsg = msg as StartRoomMassage;  
		}  

		var newTime = DateTime.Now;  
		var interval = newTime - oldTime;  
		AEDebug.Log(interval.TotalMilliseconds);  
	}  
#endif  
	private void Update()  
	{  
		NetAsyncMgr.FireMessage();  
		if (!NetAsyncMgr.IsConnected) return;  
		Upload(Time.deltaTime);  
	}  

	private void FixedUpdate()  
	{  
		if (!NetAsyncMgr.IsConnected) return;  
		m_playerMgr.OnFixedUpdate(Time.fixedDeltaTime);  
	}  

	/// <summary>  
	/// æ¥æ”¶å¸§æ•°æ®  
	/// </summary>  
	/// <param name="msg"></param>        
    private void ReciveUpdateMessage(BaseMessage msg)  
	{  
		var updateMessage = msg as UpdateMessage;  
		var updateDate = updateMessage.data;  
		if (updateDate.CurFrameIndex == m_curFrame + 1)  
		{  
			m_curFrame = updateDate.CurFrameIndex;  
			m_reciveFromLastUpLoad = true;  
			m_playerMgr.OnLogincUpdate(updateDate);  
		}  

		AEDebug.Log(updateDate.Delta);  
		AEDebug.Log("æ¥æ”¶åˆ°ç¬¬:" + updateDate.CurFrameIndex + "å¸§æ•°æ®");  
	}  

	/// <summary>  
	/// ä¸Šä¼ ç©å®¶æ¶ˆæ¯  
	/// </summary>  
	private void Upload(float delta)  
	{  
		//å¦‚æœæ²¡æœ‰æ¥æ”¶åˆ°å½“å‰å¸§åˆ™ç­‰å¾…  
		if (m_playerMgr.PlayerID == -1) return;  
		if (!m_reciveFromLastUpLoad) return;  
		m_timer += delta;  
		if (m_timer >= m_upLoadInterval)  
		{  
			m_timer = 0;  
			UpLoad();  
			AEDebug.Log("å‘å¸ƒ:" + (m_curFrame + 1) + "å¸§æ•°æ®");  
			m_reciveFromLastUpLoad = false;  
		}  
	}  

	/// <summary>  
	/// ä¸Šä¼ ç©å®¶æ¶ˆæ¯  
	/// </summary>  
	private void UpLoad()  
	{  
		UpLoadMessage upLoadMsg = new UpLoadMessage();  
		var playerInput = upLoadMsg.data;  

		playerInput.JoyX = Input.GetAxis("Horizontal");  
		playerInput.JoyY = Input.GetAxis("Vertical");  
		playerInput.PlayerID = m_playerMgr.PlayerID;  
		playerInput.CurFrameIndex = m_curFrame + 1;  

		NetAsyncMgr.Send(upLoadMsg);  
		// AEDebug.Log("ä¸Šä¼ æ•°æ®");  
	}  

	/// <summary>  
	/// è®¾ç½®ä¸Šä¼ å¸§ç‡  
	/// </summary>  
	/// <param name="FPS"></param>        private void SetFPS(int FPS)  
	{  
		m_upLoadInterval = 1f / FPS;  
	}  
}  
```
### æœåŠ¡å™¨Room

`Room`ä»£è¡¨ä¸€ä¸ªæˆ¿é—´ï¼Œè¿™é‡Œç›‘å¬**æˆå‘˜æ˜¯å¦å°±ç»ª**ã€**æˆå‘˜æ³¨å†Œ**ã€**æ¥æ”¶ç©å®¶è¾“å…¥**ç­‰æ¶ˆæ¯ã€‚

è¿™é‡Œä¹Ÿæ˜¯å®ç°äº†**ä¸Šé¢æµç¨‹**ä¸­æåˆ°çš„**æœåŠ¡å™¨**å¤§éƒ¨åˆ†å†…å®¹ã€‚

åœ¨åæœŸå®ç°**å¤šæˆ¿é—´ç³»ç»Ÿ**ï¼Œä»…ä»…åªè¦åœ¨æ¶ˆæ¯ä¸­å¤šåŠ ä¸€ä¸ª**æˆ¿é—´å·**ï¼Œä½¿ç”¨RoomMgræ¥å†æ¬¡**åˆ†å‘æˆ¿é—´æ¶ˆæ¯**ã€‚

**å¸§æ•°æ®**ç›´æ¥å­˜åœ¨æ¶ˆæ¯é‡Œé¢`private UpdateMessage m_currentFrameplayerInputs;`æ–¹ä¾¿å‘é€ï¼Œä½†æ˜¯åˆ‡è®°è¦æ¸…ç©ºï¼Œ/(ã„’oã„’)/ã€‚

å¦‚ä½•**åˆ¤æ–­**æ˜¯å¦**æ”¶åˆ°æ‰€æœ‰**å¸§æ•°æ®å‘¢ï¼Ÿ`private Dictionary<int, bool> m_IDRecived;`ç”¨ä¸€ä¸ªå­—å…¸å­˜å–ï¼Œä½†æ˜¯åˆ‡è®°è¦æ¸…ç©ºï¼Œ/(ã„’oã„’)/ã€‚

æ¥æ”¶åˆ°æˆ¿é—´å¼€å§‹åï¼Œ**ä¸‹å‘ç¬¬ä¸€å¸§ç©ºæ“ä½œ**ï¼š

```C#
private void StartRoom(BaseMessage message, ClientSocket socket)  
{  
    CurFrame = 0;  
    m_lastSendUpdateMsg = DateTime.Now;  
  
    m_currentFrameplayerInputs.data.CurFrameIndex = CurFrame;  
    m_currentFrameplayerInputs.data.NextFrameIndex = CurFrame + 1;  
    foreach (var item in m_players)  
    {  
        var playerInput = new PlayerInputData();  
        playerInput.PlayerID = item.Key;  
        playerInput.JoyX = 0;  
        playerInput.JoyY = 0;  
        m_currentFrameplayerInputs.data.PlayerInputs.Add(playerInput);  
    }  
  
    socket.serverSocket.Broadcast(m_currentFrameplayerInputs);  
    m_currentFrameplayerInputs.data.PlayerInputs.Clear();  
    Debug.Log("æ¥æ”¶åˆ°æˆ¿é—´å¼€å§‹å¹¶å‘å¸ƒç¬¬0å¸§");  
}
```

ä¸‹é¢æ˜¯æˆ‘ä»¬çš„**é‡å¤´æˆ**ï¼Œæ¥æ”¶**å„ä¸ªç©å®¶çš„æ“ä½œ**ï¼Œå¦‚æœæ¥æ”¶çš„æ“ä½œæ˜¯æœåŠ¡å™¨ä¸Š**ä¸‹ä¸€å¸§çš„æ“ä½œ**ï¼Œ**æ·»åŠ **è¿›å¸§æ•°æ®ä¸­ï¼Œå¹¶ä¸”åœ¨` m_IDRecived`è¿™ä¸ªç™»è®°è¡¨ä¸­**æ‰“å‹¾**ï¼Œåˆ¤æ–­æ˜¯å¦æ¥æ”¶**åˆ°ä½**ï¼Œåˆ°ä½ä¹‹åè½¬å‘ï¼ŒæœåŠ¡å™¨**é€»è¾‘å¸§+1**ã€‚

```C#
private void RecivePlayerInput(BaseMessage message, ClientSocket socket)  
{  
    lock (m_currentFrameplayerInputs)  
    {  
        var upLoadMessage = message as UpLoadMessage;  
        if (upLoadMessage.data.CurFrameIndex == CurFrame + 1)  
        {  
            m_IDRecived[upLoadMessage.data.PlayerID] = true;  
            m_currentFrameplayerInputs.data.PlayerInputs.Add(upLoadMessage.data);  
  
            Debug.Log("æ¥æ”¶ç¬¬" + upLoadMessage.data.CurFrameIndex + "å¸§");  
            foreach (var item in m_IDRecived.Values)  
            {  
                if (!item)  
                {  
                    return;  
                }  
            }  
  
            //æœåŠ¡å™¨å¸§æ›´æ–°  
            CurFrame += 1;  
            var span = DateTime.Now - m_lastSendUpdateMsg;  
            m_lastSendUpdateMsg = DateTime.Now;  
            Debug.Log(span.TotalSeconds.ToString());  
            //å¹¿æ’­  
            m_currentFrameplayerInputs.data.CurFrameIndex = CurFrame;  
            m_currentFrameplayerInputs.data.NextFrameIndex = CurFrame + 1;  
            m_currentFrameplayerInputs.data.Delta = (float)span.TotalSeconds;  
            socket.serverSocket.Broadcast(m_currentFrameplayerInputs);  
            Debug.Log("å‘å¸ƒç¬¬" + upLoadMessage.data.CurFrameIndex + "å¸§");  
            //æ¸…ç†  
            m_currentFrameplayerInputs.data.PlayerInputs.Clear();  
            for (int i = 0; i < m_IDRecived.Count; i++)  
            {  
                m_IDRecived[i] = false;  
            }  
        }  
    }  
}
```

å¤šçº¿ç¨‹é—®é¢˜ï¼ŒæœåŠ¡å™¨ç«¯ä½¿ç”¨çº¿ç¨‹æ± æ¥æ”¶æ•°æ®ï¼Œä¼šåŒæ—¶åˆ°è¾¾ä¸¤ä¸ªå¸§æ•°æ®ã€‚

>åœ¨ C# ä¸­ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ä¸€ä¸ªå…±äº«èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´**ç«æ€æ¡ä»¶**ï¼ˆRace Conditionï¼‰çš„å‘ç”Ÿï¼Œä»è€Œå¼•å‘æ„å¤–çš„ç»“æœæˆ–è€…æœªå®šä¹‰çš„è¡Œä¸ºã€‚

ä½¿ç”¨çº¿ç¨‹é”,é˜²æ­¢äº§ç”Ÿ**ç«æ€æ¡ä»¶**ï¼Œ

```C#
private object lockObject = new object();
private int sharedResource;

// åœ¨ä¿®æ”¹å…±äº«èµ„æºæ—¶ä½¿ç”¨é”
lock (lockObject)
{
    // ä¿®æ”¹å…±äº«èµ„æºçš„ä»£ç 
    sharedResource = newValue;
}

```

é™„ï¼š

```C#
public class Room  
{  
	public int CurFrame { get; private set; }  

	private Dictionary<int, ClientSocket> m_players;  

	private UpdateMessage m_currentFrameplayerInputs;  
	private Dictionary<int, bool> m_IDRecived;  

	private DateTime m_lastSendUpdateMsg;  

	public Room()  
	{  
		m_currentFrameplayerInputs = new UpdateMessage();  
		m_players = new Dictionary<int, ClientSocket>();  
		m_IDRecived = new Dictionary<int, bool>();  

		ClientSocket.AddListener(MessagePool.UpLoadMessage_ID, RecivePlayerInput);  
		ClientSocket.AddListener(MessagePool.RegisterSelfMessage_ID, ReciveRegisterSelfPlayer);  
		ClientSocket.AddListener(MessagePool.HeartMessage_ID, ReciveHearMessage);  
		ClientSocket.AddListener(MessagePool.StartRoomMassage_ID, StartRoom);  
	}  

	/// <summary>  
	/// æˆ¿é—´å¼€å§‹  
	/// </summary>  
	/// <param name="message"></param>        
    /// <param name="socket"></param>        
    private void StartRoom(BaseMessage message, ClientSocket socket)  
	{  
		CurFrame = 0;  
		m_lastSendUpdateMsg = DateTime.Now;  

		m_currentFrameplayerInputs.data.CurFrameIndex = CurFrame;  
		m_currentFrameplayerInputs.data.NextFrameIndex = CurFrame + 1;  
		foreach (var item in m_players)  
		{  
			var playerInput = new PlayerInputData();  
			playerInput.PlayerID = item.Key;  
			playerInput.JoyX = 0;  
			playerInput.JoyY = 0;  
			m_currentFrameplayerInputs.data.PlayerInputs.Add(playerInput);  
		}  

		socket.serverSocket.Broadcast(m_currentFrameplayerInputs);  
		m_currentFrameplayerInputs.data.PlayerInputs.Clear();  
		Debug.Log("æ¥æ”¶åˆ°æˆ¿é—´å¼€å§‹å¹¶å‘å¸ƒç¬¬0å¸§");  
	}  

	/// <summary>  
	/// æ¥æ”¶åˆ°ç©å®¶æ“ä½œ  
	/// </summary>  
	/// <param name="message"></param>        /// <param name="socket"></param>        private void RecivePlayerInput(BaseMessage message, ClientSocket socket)  
	{  
		lock (m_currentFrameplayerInputs)  
		{  
			var upLoadMessage = message as UpLoadMessage;  
			if (upLoadMessage.data.CurFrameIndex == CurFrame + 1)  
			{  
				m_IDRecived[upLoadMessage.data.PlayerID] = true;  
				m_currentFrameplayerInputs.data.PlayerInputs.Add(upLoadMessage.data);  

				Debug.Log("æ¥æ”¶ç¬¬" + upLoadMessage.data.CurFrameIndex + "å¸§");  
				foreach (var item in m_IDRecived.Values)  
				{  
					if (!item)  
					{  
						return;  
					}  
				}  

				//æœåŠ¡å™¨å¸§æ›´æ–°  
				CurFrame += 1;  
				var span = DateTime.Now - m_lastSendUpdateMsg;  
				m_lastSendUpdateMsg = DateTime.Now;  
				Debug.Log(span.TotalSeconds.ToString());  
				//å¹¿æ’­  
				m_currentFrameplayerInputs.data.CurFrameIndex = CurFrame;  
				m_currentFrameplayerInputs.data.NextFrameIndex = CurFrame + 1;  
				m_currentFrameplayerInputs.data.Delta = (float)span.TotalSeconds;  
				socket.serverSocket.Broadcast(m_currentFrameplayerInputs);  
				Debug.Log("å‘å¸ƒç¬¬" + upLoadMessage.data.CurFrameIndex + "å¸§");  
				//æ¸…ç†  
				m_currentFrameplayerInputs.data.PlayerInputs.Clear();  
				for (int i = 0; i < m_IDRecived.Count; i++)  
				{  
					m_IDRecived[i] = false;  
				}  
			}  
		}  
	}  

	/// <summary>  
	/// æ¥æ”¶æ³¨å†Œæ¶ˆæ¯  
	/// </summary>  
	/// <param name="message"></param>        
    /// <param name="socket"></param>        
    private void ReciveRegisterSelfPlayer(BaseMessage message, ClientSocket socket)  
	{  
		if (m_players.ContainsValue(socket))  
		{  
			return;  
		}  

		foreach (var client in socket.serverSocket.clientSockets.Values)  
		{  
			//è¿”å›æ³¨å†Œå½“å‰è¯·æ±‚å®¢æˆ·ç«¯  
			if (socket == client)  
			{  
				//æ³¨å†Œè‡ªå·±  
				RegisterSelfMessage registerSelfMessage = new RegisterSelfMessage();  
				registerSelfMessage.data.PlayerID = m_players.Count;  
				client.Send(registerSelfMessage);  
			}  
			//è¿”å›æ³¨å†Œå…¶ä»–å®¢æˆ·ç«¯  
			else  
			{  
				RegisterMessage registerMessage = new RegisterMessage();  
				registerMessage.data.PlayerID = m_players.Count;  
				client.Send(registerMessage);  
			}  
		}  

		m_IDRecived.Add(m_players.Count, false);  
		m_players.Add(m_players.Count, socket);  
	}  

	/// <summary>  
	/// æ¥æ”¶åˆ°å¿ƒè·³æ¶ˆæ¯  
	/// </summary>  
	/// <param name="arg1"></param>        
    /// <param name="arg2"></param>        
    private void ReciveHearMessage(BaseMessage arg1, ClientSocket arg2)  
	{  
		Debug.Log("å¿ƒè·³æ¶ˆæ¯");  
	}  
}  
```

### BUGS

æ¯æ¬¡**é—´éš”66ms**çœŸçš„æ˜¯é—´éš”66msæ‰**æ”¶é›†æ•°æ®**å—,è€Œä¸æ˜¯**æå‰æ”¶é›†æ•°æ®**ç­‰åˆ°66mså†å»å‘é€å—?
æˆ‘æ€€ç–‘è¿™æ˜¯**è¾“å…¥ä¸çµæ•**çš„ä¸€ä¸ªåŸå› ã€‚

ç°åœ¨æ€»ç®—æ˜¯ç›´åˆ°ä¸ºå•¥è¦ç”¨è‡ªå·±çš„ç‰©ç†å¼•æ“åšå¸§åŒæ­¥äº†ï¼Œå› ä¸ºUnityçš„ç‰©ç†å¼•æ“æ²¡åŠæ³•æ ¹æ®æˆ‘ä»¬è‡ªå·±çš„é€»è¾‘å¸§æ¥æ›´æ–°ï¼Œ**é€»è¾‘å¸§**æ›´æ–°å’Œ**ç‰©ç†å¸§**æ›´æ–°æ—¶é—´ç‚¹**ä¸ä¸€è‡´**ï¼Œå¯¼è‡´**ç›¸åŒçš„è¾“å…¥**ï¼Œ**ä¸åŒçš„è¾“å‡º**ï¼Œè¿™æ˜¯å¸§åŒæ­¥**æœ€å¿Œè®³çš„**ã€‚

## è¿½å¸§

å…¶å®åœ¨TCPä¸­ ä¸å¤ªå¯èƒ½å‡ºç°æ‰åŒ…ï¼Œå› ä¸ºTCPçš„**ä¸¢åŒ…é‡å‘æœºåˆ¶**å’Œ**æœ‰åºæ€§**

å¦‚æœè¦å¼•å…¥**è¿½å¸§**è¿™ä¸ªæ¦‚å¿µï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ä¸èƒ½å†**ç­‰å¾…**æ‰€æœ‰å®¢æˆ·çš„æ“ä½œï¼Œå¿…é¡»ä¹Ÿæ˜¯ä»¥**ä¸€å®šæ—¶é—´**æ¥æ”¶ç©å®¶çš„æ“ä½œï¼Œå¦‚æœæ—¶é—´åˆ°äº†è¿˜æœªåˆ°çš„ç©å®¶æ“ä½œæœåŠ¡å™¨å°†ä¼šè®¤ä¸ºæ˜¯**ç©ºæ“ä½œ**ï¼Œç›´æ¥å°†ä¸‹ä¸€å¸§å‘å‡ºå»ï¼ŒæœåŠ¡å™¨**é€»è¾‘å¸§+1**ã€‚

è¿™é‡Œ**ä¸€å®šæ—¶é—´**æœ€å¥½æ˜¯ä¸å®¢æˆ·ç«¯å‘é€åŒæ­¥çš„æ—¶é—´ï¼Œå¯æ˜¯è¦æ˜¯å®¢æˆ·ç«¯ä¼ è¾“æ—¶é—´**çš†å¤§äº**æœåŠ¡å™¨çš„ç­‰å¾…æ—¶é—´æ€ä¹ˆåŠï¼Ÿé‚£å²‚ä¸æ˜¯æ¯ä¸€å¸§éƒ½æ˜¯**ç©ºæ“ä½œ**ï¼Ÿ

æˆ‘ä»¬å…ˆæš‚ä¸”å°†æœåŠ¡å™¨ç­‰å¾…æ—¶é—´**ç•¥å¤§äº**å®¢æˆ·ç«¯æ—¶é—´ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œå¦‚æœåœ¨ç­‰åˆ°æ—¶é—´å‰**éƒ½åˆ°é½**äº†ï¼Œ**å‘é€ä¸‹ä¸€å¸§**ï¼ŒæœåŠ¡å™¨**é€»è¾‘å¸§+1**ã€‚

æœåŠ¡å™¨åœ¨æ¥æ”¶çš„æ—¶å€™ï¼Œåˆ¤æ–­æ¥æ”¶çš„å¸§æ˜¯å¦æ˜¯å½“å‰å¸§ï¼Œå¦‚æœä¸æ˜¯åˆ™

å®¢æˆ·ç«¯ï¼šè¯¥æˆ‘å‡ºåœºäº†ã€‚

å¦‚æœå®¢æˆ·ç«¯æ¥æ”¶åˆ°å¤§äºå½“å‰å¸§çš„æ•°æ®